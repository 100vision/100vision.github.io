import{_ as n,W as a,X as s,Z as e,$ as o,a0 as t,Y as l,G as d}from"./framework-b5535326.js";const r={},c=l(`<h2 id="症状" tabindex="-1"><a class="header-anchor" href="#症状" aria-hidden="true">#</a> 症状</h2><ul><li>最初是发现组策略不同步到所有域控。进而发现sysvol文件夹在域控之间不同步。</li><li>又在域控的DFS管理中发现DFSR SysVol (Domain Sysvol Volumes）复制组消失！</li></ul><h2 id="背景" tabindex="-1"><a class="header-anchor" href="#背景" aria-hidden="true">#</a> 背景</h2><ul><li>DC域控都是从Windows Server 2008升级到Windows Server 2016.</li><li>2个站点多域控制器；</li><li>Sysvol复制协议几个月前从FRS升级到了DFSr</li></ul><h2 id="问题影响" tabindex="-1"><a class="header-anchor" href="#问题影响" aria-hidden="true">#</a> 问题影响</h2><ul><li>主要是影响组策略无法下发因为sysvol文件不同步；</li></ul><h2 id="排错步骤" tabindex="-1"><a class="header-anchor" href="#排错步骤" aria-hidden="true">#</a> 排错步骤</h2><ul><li><p>在所有域控上，使用<code>dcdiag /test:sysvolcheck /e</code> 检查SysVol也没有报任何错误；看起来正常；</p></li><li><p>在所有域控上，使用<code>repadmin /syncall /AedP</code>立刻同步一次，没有变化; <code>repladmin /replsummary</code> 也没看到任何错误；</p></li><li><p>考虑到SysVol是使用DFS协议同步，检查事件查看器里的DFS日志，没有发现类似event id <code>2212</code>（指示DFS数据库脏关闭的信息）；</p></li></ul><div class="hint-container tip"><p class="hint-container-title">提示</p><p>DFS数据库不正常关闭可能导致DFS停止复制。一般事件日志可以看懂2212或2213等event ID。</p></div><ul><li>使用WMIC检查数据库健康，输出<code>没有可用实例</code> 或 <code>no available instance(s).</code></li></ul><div class="hint-container tip"><p class="hint-container-title">提示</p><p>可以使用 <code>Wmic /namespace:\\\\root\\microsoftdfs path dfsrreplicatedfolderinfo get replicationgroupname,replicatedfoldername,state</code> 检查数据库状态。如果看到数据库状态异常，DFS停止复制，可以使用 <code>wmic /namespace:\\\\root\\microsoftdfs path dfsrVolumeConfig where volumeGuid=&lt;GUID&gt; call ResumeReplication</code> 恢复复制。</p></div><ul><li>问题好像比较严重，感觉有点无助，感觉要把问题的DC废了重建才能解决。</li></ul><h2 id="解决办法" tabindex="-1"><a class="header-anchor" href="#解决办法" aria-hidden="true">#</a> 解决办法：</h2><blockquote><p>Google了很久，终于找到了类似问题的解决办法，不用废掉问题DC。</p></blockquote><blockquote><p>具体原理是，通过修改注册表，把所有DC上的DFS SYSVOL复制组状态恢复到DC提升前的状态，使得所有DC会从PDC Emulator角色的DC那里重新复制SYSVOL，最终完成重建SYSVOL复制组。</p></blockquote><h3 id="步骤" tabindex="-1"><a class="header-anchor" href="#步骤" aria-hidden="true">#</a> 步骤</h3><ul><li><p>备份AD （PDC的系统状态）</p></li><li><p>停掉所有DC上的DFS服务（重要）</p></li><li><p>登录到PDC， 打开ADSI工具，连接到默认上下文。</p></li><li><p>在ADSI中修改AD数据库（清理过时数据</p></li><li><p>主要是检查 OU=Domain Controllers 下的 CN=DFSR-LocalSettings，删除该文件夹下所有内容和子文件夹。</p></li><li><p>回到 CN=Systems &gt; CN=DFSR-GlobalSettings，继续检查和删除其下的所有内容和子文件夹，确保没有其他活动的复制组。</p></li><li><p>在所有DC上执行一次手动复制,确保以上修改复制到所有DC。</p></li></ul><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>repadmin /syncall /AdeP
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>修改PDC上的注册表。注册表内容如下：</li></ul><div class="hint-container note"><p class="hint-container-title">注意1</p><p>需要根据实际情况替换SYSVOL文件夹位置。在这个例子中，因为我有把SYSVOL复制协议从Frs-r升级到DFS-R，所以对应的SYSVOL文件夹名是<code>SYSVOL_DFSR</code>,不再是<code>SYSVOL</code></p></div>`,20),u={class:"hint-container note"},m=l(`<p class="hint-container-title">注意2</p><p>注册表里出现的文件夹，如果没有, 例如staging area 需要事先手动创建。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Windows Registry Editor Version 5.00

[HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\DFSR\\Parameters\\SysVols\\Promoting SysVols]
&quot;Sysvol Information is Committed&quot;=dword:00000001

[HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\DFSR\\Parameters\\SysVols\\Promoting SysVols\\example.com]
&quot;Is Primary&quot;=dword:00000001
&quot;Command&quot;=&quot;DcPromo&quot;
&quot;Parent Computer&quot;=&quot;&quot;
&quot;Replicated Folder Name&quot;=&quot;example.com&quot;
&quot;Replicated Folder Root&quot;=&quot;C:\\\\Windows\\\\SYSVOL_DFSR\\\\domain&quot;
&quot;Replicated Folder Root Set&quot;=&quot;C:\\\\Windows\\\\SYSVOL_DFSR\\\\sysvol\\\\example.com&quot;
&quot;Replicated Folder Stage&quot;=&quot;C:\\\\Windows\\\\SYSVOL_DFSR\\\\staging areas\\\\example.com&quot;
&quot;Replication Group Name&quot;=&quot;example.com&quot;
&quot;Replication Group Type&quot;=&quot;Domain&quot;

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>启动PDC上DFS服务，并等待3分钟左右。</p></li><li><p>如果一切顺利，以上注册表内容在PDC上会发生变化（消失）。取而代之的是： <code>HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\services\\DFSR\\Parameters\\SysVols\\Seeding Sysvols</code></p></li><li><p>回到ADSI, 将能看到 <code>CN=System &gt; CN=DFSR-GlobalSettings &gt; CN=Domain System Volume &gt; CN=Topology &gt; CN=&lt;your primary dc&gt;</code></p></li><li><p>再在所有DC上执行一遍手动复制.</p></li><li><p>在剩下所有DC上依次执行以下：</p></li><li><p>a. 添加以下注册表内容：</p></li></ul><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Windows Registry Editor Version 5.00

[HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\DFSR\\Parameters\\SysVols\\Promoting SysVols]
&quot;Sysvol Information is Committed&quot;=dword:00000001

[HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\DFSR\\Parameters\\SysVols\\Promoting SysVols\\example.com]
&quot;Is Primary&quot;=dword:00000000
&quot;Command&quot;=&quot;DcPromo&quot;
&quot;Parent Computer&quot;=&quot;primary-dc.example.com&quot;
&quot;Replicated Folder Name&quot;=&quot;example.com&quot;
&quot;Replicated Folder Root&quot;=&quot;C:\\\\Windows\\\\SYSVOL_DFSR\\\\domain&quot;
&quot;Replicated Folder Root Set&quot;=&quot;C:\\\\Windows\\\\SYSVOL_DFSR\\\\sysvol\\\\example.com&quot;
&quot;Replicated Folder Stage&quot;=&quot;C:\\\\Windows\\\\SYSVOL_DFSR\\\\staging areas\\\\example.com&quot;
&quot;Replication Group Name&quot;=&quot;example.com&quot;
&quot;Replication Group Type&quot;=&quot;Domain&quot;

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>b. 启动DFS服务</p></li><li><p>c. 执行repadmin复制</p></li><li><p>d . 检查ADSI</p></li><li><p>最后，检查DFS命名空间是否出现了SYSVOL复制组。</p></li><li><p>至此问题解决！</p></li></ul><h2 id="参考" tabindex="-1"><a class="header-anchor" href="#参考" aria-hidden="true">#</a> 参考</h2>`,7),p={href:"https://community.spiceworks.com/how_to/160786-how-to-re-build-sysvol-dfsr-replication-group-without-demoting-promoting-dc",target:"_blank",rel:"noopener noreferrer"},v={href:"https://serverfault.com/questions/745599/deleted-domain-system-volume-how-do-i-recreate-it-i-have-no-backups",target:"_blank",rel:"noopener noreferrer"};function S(h,q){const i=d("ExternalLinkIcon");return a(),s("div",null,[c,e("div",u,[m,e("p",null,[e("a",p,[o("https://community.spiceworks.com/how_to/160786-how-to-re-build-sysvol-dfsr-replication-group-without-demoting-promoting-dc"),t(i)])]),e("p",null,[e("a",v,[o("https://serverfault.com/questions/745599/deleted-domain-system-volume-how-do-i-recreate-it-i-have-no-backups"),t(i)])])])])}const b=n(r,[["render",S],["__file","win_ad_troubleshooting_01.html.vue"]]);export{b as default};
