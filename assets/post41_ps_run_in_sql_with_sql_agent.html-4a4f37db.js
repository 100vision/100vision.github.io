import{_ as o,W as n,X as r,Z as e,$ as t,a0 as i,Y as l,G as a}from"./framework-b5535326.js";const c="/assets/post41_ps_sql_agent_turn_on-a929b110.jpg",_="/assets/post41_ps_sql_agent_new_job_type-c40cc77e.jpg",p="/assets/post41_ps_sql_agent_new_job_output-c0ae8b34.jpg",d="/assets/post41_ps_sql_agent_new_job_schedule-87f88049.jpg",h={},g=l('<div class="hint-container tip"><p class="hint-container-title">背景</p><p>有个需求就是：在没有SQL Server服务器操作系统账户、只有数据库账户sa情况下，把远程SQL服务器上的某个文件上传到sftp服务器。前面尝试使用存储过程<code>xp_cmdshell</code>执行Powershell脚本来完成，但没有成功，没成功的原因可能是脚本内容有一下特殊字符，包裹在xp_cmdshell的<code>cmd_string</code>里转义失败。后来 发现通过<code>SQL Agent</code>的job作业也可以执行Powershell脚本，而且更方便强大，可以计划调度运行。</p></div><h2 id="sql-server-agent介绍" tabindex="-1"><a class="header-anchor" href="#sql-server-agent介绍" aria-hidden="true">#</a> SQL Server Agent介绍</h2><blockquote><p>SQL Server 代理是一项 Microsoft Windows 服务，它在执行计划的管理任务，这些任务 SQL Server 中被称为“作业”.SQL Server 代理使用 SQL Server 存储作业信息。 作业包含一个或多个作业步骤。 每个步骤都有自己的任务。例如，备份数据库。SQL Server 代理可以按照计划运行作业，也可以在响应特定事件时运行作业，还可以根据需要运行作业。 例如，如果希望在每个工作日下班后备份公司的所有服务器，就可以使该任务自动执行</p></blockquote><blockquote><p>支持很多脚本语言。例如SQL/Powershell/cmdExec</p></blockquote><h2 id="使用sql-server-agent执行powershell脚本" tabindex="-1"><a class="header-anchor" href="#使用sql-server-agent执行powershell脚本" aria-hidden="true">#</a> 使用SQL Server Agent执行Powershell脚本</h2><blockquote><p>默认情况下，SQL Server 安装后 SQL Server 代理服务处于禁用状态，除非用户明确选择自动启动该服务。</p></blockquote><ul><li><p>登录SQL Server Management Studio。</p></li><li><p>启动SQL Server Agent服务。右键[SQL Server代理]，点击“启动”。 <img src="'+c+'" alt="启动SQLAgent" loading="lazy"></p></li><li><p>新建作业。作业内容有：动作步骤，、计划时间以及通知等。</p></li><li><p>新建一个作业步骤。并指定作业类型为<code>Powershell</code>.</p></li></ul><figure><img src="'+_+'" alt="指定作业类型" tabindex="0" loading="lazy"><figcaption>指定作业类型</figcaption></figure><ul><li><p>点击【打开】定位到写好的Powershell脚本文件然后加载。</p></li><li><p>点击【高级】标签页，指定作业输出文件。如果脚本没有按照预期执行，可以通过查看输出检查脚本。 <img src="'+p+'" alt="指定脚本输出" loading="lazy"></p></li><li><p>设置作业执行计划。</p></li></ul><figure><img src="'+d+'" alt="设置调度计划" tabindex="0" loading="lazy"><figcaption>设置调度计划</figcaption></figure><ul><li>设置作业执行结果通知。支持邮件等通知，步骤略。</li></ul>',11),u={class:"hint-container tip"},S=e("p",{class:"hint-container-title"},"关于SQL Agent作业运行身份",-1),f=e("code",null,"SQL Server 代理服务账户",-1),v=e("code",null,"NT Service\\SQLSERVERAGENT",-1),m=e("code",null,"虚拟服务账户",-1),L={href:"https://learn.microsoft.com/en-us/sql/database-engine/configure-windows/configure-windows-service-accounts-and-permissions?redirectedfrom=MSDN&view=sql-server-ver16#VA_Desc",target:"_blank",rel:"noopener noreferrer"},Q=e("h2",{id:"side-notes-关于文件上传脚本",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#side-notes-关于文件上传脚本","aria-hidden":"true"},"#"),t(" Side Notes : 关于文件上传脚本")],-1),q=e("p",null,"实现原理是通过WinSCP的运行库实现的，通过sftp协议上传文件到远程sftp服务器。脚本将在下一个文章介绍。",-1);function b(w,x){const s=a("ExternalLinkIcon");return n(),r("div",null,[g,e("div",u,[S,e("p",null,[t("默认SQL Agent服务是使用一个叫"),f,t("，即"),v,t("，这是一个"),m,t("(Virtual Account) ，在本地计算机管理看不到的，点击"),e("a",L,[t("这里了解什么是虚拟账户"),i(s)]),t(" 应该是权限比较低的账户，不能执行一些权限要求高的任务。如果需要执行，需要在服务管理把服务账户换成高权限账户。")])]),Q,q])}const A=o(h,[["render",b],["__file","post41_ps_run_in_sql_with_sql_agent.html.vue"]]);export{A as default};
