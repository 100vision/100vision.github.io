import{_ as s,W as n,X as a,Y as e}from"./framework-b5535326.js";const t={},p=e(`<div class="hint-container tip"><p class="hint-container-title">适用场景</p><p>个人感觉适合在SQLServer里执行一些简单的Powershell任务。如果脚本含有一些特殊字符，执行容易出错。不如使用SQL Server Agent功能强大，可以执行更多脚本任务。</p></div><p>To execute a PowerShell script block using SQL Server&#39;s <code>xmlcmdshell</code> stored procedure, you can follow these steps:</p><ol><li>Enable the <code>xp_cmdshell</code> feature in SQL Server, if it&#39;s not already enabled. Execute the following SQL command:</li></ol><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">EXEC</span> sp_configure <span class="token string">&#39;show advanced options&#39;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">RECONFIGURE</span><span class="token punctuation">;</span>
<span class="token keyword">EXEC</span> sp_configure <span class="token string">&#39;xp_cmdshell&#39;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">RECONFIGURE</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>Execute the PowerShell script block using the <code>xp_cmdshell</code> stored procedure:</li></ol><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">DECLARE</span> <span class="token variable">@ps_script</span> NVARCHAR<span class="token punctuation">(</span>MAX<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">SET</span> <span class="token variable">@ps_script</span> <span class="token operator">=</span> <span class="token string">&#39;&amp;{$items = get-childitem c:\\;$items | ForEach-Object { write-output $_.fullname}}&#39;</span><span class="token punctuation">;</span>

<span class="token keyword">DECLARE</span> <span class="token variable">@cmd</span> NVARCHAR<span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">SET</span> <span class="token variable">@cmd</span> <span class="token operator">=</span> N<span class="token string">&#39;powershell.exe -c &quot;&#39;</span> <span class="token operator">+</span> <span class="token variable">@ps_script</span> <span class="token operator">+</span> N<span class="token string">&#39;&quot;&#39;</span><span class="token punctuation">;</span>

<span class="token keyword">DECLARE</span> <span class="token variable">@output</span> <span class="token keyword">TABLE</span> <span class="token punctuation">(</span>output NVARCHAR<span class="token punctuation">(</span>MAX<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token variable">@output</span>
<span class="token keyword">EXEC</span> xp_cmdshell <span class="token variable">@cmd</span><span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> output <span class="token keyword">FROM</span> <span class="token variable">@output</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container tip"><p class="hint-container-title">Important Notes</p><ul><li><p>Enclose the script block in the &amp; symbol to indicate that it&#39;s a command to be executed.</p></li><li><p>the comand string for the stored procedure <code>xp_cmdshell</code> has to be either varchar(8000) or nvarchar(4000)</p></li></ul></div>`,7),l=[p];function o(c,i){return n(),a("div",null,l)}const d=s(t,[["render",o],["__file","post39_ps_run_in_sql_xmlshell.html.vue"]]);export{d as default};
