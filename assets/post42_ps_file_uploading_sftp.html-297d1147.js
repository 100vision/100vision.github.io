import{_ as t,W as a,X as r,Z as e,$ as i,a0 as s,Y as l,G as d}from"./framework-2e6688e7.js";const o="/assets/post42_ps_sftp_generate_key_pairs_step1-bc5e684c.jpg",v="/assets/post42_ps_sftp_generate_key_pairs_step2-49718b92.jpg",c="/assets/post42_ps_sftp_generate_key_pairs_step3-9cc6822d.jpg",u="/assets/post42_ps_sftp_generate_code_template_step1-71312088.jpg",p="/assets/post42_ps_sftp_generate_code_template_step2-770373f3.jpg",m={},b={class:"hint-container tip"},h=e("p",{class:"hint-container-title"},"背景",-1),_={href:"https://blog.solex-inc.com/zh/%E4%BF%A1%E6%81%AF%E6%8A%80%E6%9C%AF/%E7%BC%96%E7%A8%8B/post41_ps_run_in_sql_with_sql_agent.html",target:"_blank",rel:"noopener noreferrer"},P=e("h2",{id:"先说winscp",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#先说winscp","aria-hidden":"true"},"#"),i(" 先说WinSCP")],-1),f=e("blockquote",null,[e("p",null,"WinSCP是Windows下一个很常用、很受欢迎的开源FTP/SFTP客户端，版本更新的很快。")],-1),S={href:"https://winscp.net/eng/download.php",target:"_blank",rel:"noopener noreferrer"},g=l(`<p>WinSCP supports five transfer protocols:</p><pre><code>SFTP (SSH File Transfer Protocol);
FTP (File Transfer Protocol);
SCP (Secure Copy Protocol);
WebDAV (Web Distributed Authoring and Versioning);
S3 (Amazon S3).
</code></pre><blockquote><p>另外，还提供了Assembly（API)，可以编程实现文件上传、下载和同步功能，本文重点。</p></blockquote><h2 id="实现" tabindex="-1"><a class="header-anchor" href="#实现" aria-hidden="true">#</a> 实现</h2><div class="hint-container tip"><p class="hint-container-title">提示</p><p>以下是使用sftp协议举例实现文件上传，FTP实现差不多.</p></div><h3 id="准备工作" tabindex="-1"><a class="header-anchor" href="#准备工作" aria-hidden="true">#</a> 准备工作</h3>`,6),C={href:"https://github.com/drakkan/sftpgo",target:"_blank",rel:"noopener noreferrer"},y=e("li",null,"WinSCP Assembly文件",-1),q=e("li",null,"sftp账户公钥和私钥。",-1),w=l(`<h3 id="脚本" tabindex="-1"><a class="header-anchor" href="#脚本" aria-hidden="true">#</a> 脚本</h3><div class="language-Powershell line-numbers-mode" data-ext="Powershell"><pre class="language-Powershell"><code>
&lt;#
 - Function: File Uploading through WinSCP/sftp with SSL Auth option, without clear text password provided
 - Prerequisites: WinSCP Assembly
 - Author: tlin82

#&gt;

Function Upload-FileBySFTP() {

param (
        [string]$LocalFilePath,
        [string]$RemoteFilePath
        )

    #Load WinSCP Assembly
    Add-Type -Path &quot;C:\\ssh\\WinSCPNet.dll&quot;

    # Set up session options for a SFTP Session
    # follow code snippet can be generated by WinSCP Session Code Template Generator. See WinSCP documentation for details.
    $sessionOptions = New-Object WinSCP.SessionOptions -Property @{
        Protocol = [WinSCP.Protocol]::Sftp
        HostName = &quot;my-sftp-server.example.com&quot;
        PortNumber = 2022
        UserName = &quot;test&quot;
        SshHostKeyFingerprint = &quot;ssh-ed25519 255 QDYKkMIo/hIkobREzJBLeI1KyHkXDwrkGGJtmISVwwc&quot;
        ##Private Key
        SshPrivateKeyPath = &quot;C:\\ssh\\private.ppk&quot;
        # Use Pass phrase to protect the private key
        PrivateKeyPassphrase = &quot;acJ-Ub-YHgloHh7hbR6a&quot;

    }



    # Set up transfer options
    $transferOptions = New-Object WinSCP.TransferOptions
    $transferOptions.TransferMode = [WinSCP.TransferMode]::Binary
    #Speed limit to 500KB/s
    $transferOptions.SpeedLimit = 500
    # Enable Resume Support for all files.
    $transferOptions.ResumeSupport.State = [WinSCP.TransferResumeSupportState]::On


    $session = New-Object WinSCP.Session
    try
    {
        # Connection
        $session.Open($sessionOptions)
        # Upload the file to the FTP server
        $session.PutFiles($LocalFilePath, $RemoteFilePath, $False, $transferOptions).Check()

    }

    finally
    {
        $session.Dispose()
    }
    

}




if (Test-Path -Path &quot;C:\\ssh\\WinSCPNet.dll&quot;) {

    Upload-FileBySFTP -LocalFilePath &quot;D:\\source\\file_to_be_uploaded.zip&quot; -RemoteFilePath &quot;/file_to_be_uploaded.zip&quot;


  }


# Provision WinSCP assembly on the server where the file is uploaded from. The assebmly can be found in WinSCP install directory.
# if not available on the server, either download from a http server that holds the WinSCP assembly. In this case, the http server is served with Node.js Express, a simple http server.
# Alternatively get a copy of the assembly files from anywhere else . Whatever,as long as the assembly is available for the file uploading function to load.


else {
        $url_lib = &quot;http://http-server:3000/download/1&quot;
        $outputPath_lib = &quot;C:\\ssh\\WinSCPNet.dll&quot;

        $url_exec = &quot;http://http-server:3000/download/2&quot;
        $outputPath_exec = &quot;C:\\ssh\\WinSCP.exe&quot;

        $url_sslKey = &quot;http://http-server:3000/download/3&quot;
        $outputPath_sslKey = &quot;C:\\ssh\\private.ppk&quot;

        $webClient = New-Object System.Net.WebClient
        $webClient.DownloadFile($url_lib, $outputPath_lib)
        $webClient.DownloadFile($url_exec, $outputPath_exec)
        $webClient.DownloadFile($url_sslKey, $outputPath_sslKey)

        Upload-FileBySFTP -LocalFilePath &quot;D:\\source\\file_to_be_uploaded.zip&quot; -RemoteFilePath &quot;/file_to_be_uploaded.zip&quot;
  }
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="脚本详细说明" tabindex="-1"><a class="header-anchor" href="#脚本详细说明" aria-hidden="true">#</a> 脚本详细说明</h3><ol><li><strong>关于WinSCP Assembly文件准备细节</strong></li></ol><p>为了脚本可以调用，需要准备Assebly文件，可以在WinSCP安装目录下找到。并在脚本中指定然后加载。需要的文件有：</p><ul><li>WinSCP.exe</li><li>WinSCPNet.dll</li></ul><ol start="2"><li><strong>如果WinSCP没有安装</strong></li></ol><p>可以搭建一个简单的HTTP服务器，并使用脚本的<code>webclient</code>对象实现下载一个副本</p><ol start="3"><li><strong>关于免密登录sftp服务器的实现细节</strong></li></ol><p>免密登录是因为使用了SSH密钥，密钥对通过WinSCP/putty工具生成。一般是把公钥上传到sftp用户主目录下。本例中使用的sftp服务器是sftpGo，是把公钥文本拷贝到用户配置里保存（通过sftpGO Web admin portal)</p><ol start="4"><li><strong>关于脚本中sftp会话选项参数</strong>*</li></ol><p>WinSCP的会话参数是通过WinSCP会话工具代码模板生成器生成的，比较方便。使用方法是：</p><ul><li><p>启动WinSCP，新建站点，并生成密钥对用于登录sftp服务器； <img src="`+o+'" alt="1" loading="lazy"><img src="'+v+'" alt="2" loading="lazy"><img src="'+c+'" alt="3" loading="lazy"></p></li><li><p>登录成功后，点击菜单上的【会话】，点击【代码生成】如下图： <img src="'+u+'" alt="1" loading="lazy"><img src="'+p+'" alt="1" loading="lazy"></p></li><li><p>复制代码</p></li></ul>',13);function W(F,$){const n=d("ExternalLinkIcon");return a(),r("div",null,[e("div",b,[h,e("p",null,[i("前篇文章 "),e("a",_,[i("在SQL Agent里运行Powershell实现文件上传"),s(n)]),i("介绍了一个文件上传需求，具体实现是通过Powershell调用WinSCP的Assembly实现的，本篇详细介绍。")])]),P,f,e("p",null,[i("官方主页 "),e("a",S,[i("https://winscp.net/eng/download.php"),s(n)])]),g,e("ul",null,[e("li",null,[i("1台可运行sftp服务器（可以使用 "),e("a",C,[i("sftpGo"),s(n)]),i(" 实现部署）和账户，步骤略。")]),y,q]),w])}const T=t(m,[["render",W],["__file","post42_ps_file_uploading_sftp.html.vue"]]);export{T as default};
